// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(100)
  email      String   @unique @db.VarChar(100)
  password   String   @db.VarChar(255)
  role       Role     @default(customer)
  status     Status   @default(pending)
  rejection_reason  String?  @db.Text
  resubmitted_at  DateTime? @db.Timestamptz(6)
  resubmit_allowed  Boolean @default(true) 
  phone      String   @unique @db.VarChar(20)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  email_is_verified Boolean @default(false)
  

  coProfile    CoProfile?
  mitraProfile MitraProfile?

  referred     Referral[] @relation("ReferredUsers")
  referralsMade Referral[] @relation("ReferringUsers")
  verificationTokens VerificationToken[]
  points        Point[]
}

model CoProfile {
  id                Int      @id @default(autoincrement())
  user_id           Int      @unique
  name              String   @db.VarChar(100)
  email             String   @unique @db.VarChar(100)
  nik               String   @unique @db.VarChar(20)
  birth_place       String   @db.VarChar(100)
  birth_date        DateTime @db.Date
  gender            Gender
  address_province_code String   @db.VarChar(10)
  address_province_name String   @db.VarChar(100)
  address_regency_code  String   @db.VarChar(10)
  address_regency_name  String   @db.VarChar(100)
  address_district_code String   @db.VarChar(10)
  address_district_name String   @db.VarChar(100)
  address_village_code  String   @db.VarChar(10)
  address_village_name  String   @db.VarChar(100)
  address_postal_code   String   @db.VarChar(10)
  address_detail    String   @db.Text
  job               String   @db.VarChar(100)
  marital_status    String   @db.VarChar(50)
  education         String   @db.VarChar(50)
  selfie_url        String   @db.VarChar(255)
  is_verified       Boolean  @default(false)
  approved_at       DateTime? @db.Timestamptz(6)
  referral_code String? @unique @db.VarChar(10)
  latitude          Float?
  longitude         Float?


  user User @relation(fields: [user_id], references: [id])

  @@map("co_profiles")
}

model MitraProfile {
  id                        Int      @id @default(autoincrement())
  user_id                   Int      @unique
  pic_name                  String   @db.VarChar(100)
  pic_phone                 String   @db.VarChar(20)
  pic_email                 String   @db.VarChar(100)
  pic_status                PicStatus
  owner_name                String   @db.VarChar(100)
  owner_phone               String   @unique @db.VarChar(20)
  owner_email               String   @db.VarChar(100)
  owner_ktp                 String   @db.VarChar(50)
  owner_address_province_code String   @db.VarChar(10)
  owner_address_province_name String   @db.VarChar(100)
  owner_address_regency_code  String   @db.VarChar(10)
  owner_address_regency_name  String   @db.VarChar(100)
  owner_address_district_code String   @db.VarChar(10)
  owner_address_district_name String   @db.VarChar(100)
  owner_address_village_code  String   @db.VarChar(10)
  owner_address_village_name  String   @db.VarChar(100)
  owner_address_detail      String   @db.Text
  owner_address_postal_code   String   @db.VarChar(10)
  business_type             BusinessType
  business_entity           String   @db.VarChar(50)
  business_name             String?   @db.VarChar(100)
  business_address_province_code String   @db.VarChar(10)
  business_address_province_name String   @db.VarChar(100)
  business_address_regency_code  String   @db.VarChar(10)
  business_address_regency_name  String   @db.VarChar(100)
  business_address_district_code String   @db.VarChar(10)
  business_address_district_name String   @db.VarChar(100)
  business_address_village_code  String   @db.VarChar(10)
  business_address_village_name  String   @db.VarChar(100)
  business_address_postal_code   String   @db.VarChar(10)
  business_address_detail   String   @db.Text
  business_duration         String   @db.VarChar(50)
  social_media_platform     String   @db.VarChar(50)
  social_media_account      String   @db.VarChar(100)
  is_verified               Boolean  @default(false)
  approved_at               DateTime? @db.Timestamptz(6)
  latitude                  Float?
  longitude                 Float?
  store_images              String  @db.Text


  user User @relation(fields: [user_id], references: [id])

  @@map("mitra_profiles")
}

model Address {
  id          Int      @id @default(autoincrement())
  province    String   // e.g., "DKI Jakarta"
  city        String   // e.g., "Jakarta Pusat"
  district    String   // Kecamatan, e.g., "Gambir"
  subdistrict String   // Kelurahan, e.g., "Petojo Selatan"
  latitude    Float
  longitude   Float
  
  @@unique([province, city, district, subdistrict]) // Menjamin setiap alamat unik
}

model Referral {
  id           Int     @id @default(autoincrement())
  referrer_id  Int     // ID dari CO yang memberi referral
  referred_id  Int     @unique // ID dari user baru yang direferensikan
  type         Role    // 'co' atau 'mitra'
  reward_point Int
  rewarded     Boolean @default(false)
  created_at   DateTime @default(now())

  referrer User @relation("ReferringUsers", fields: [referrer_id], references: [id])
  referred User @relation("ReferredUsers", fields: [referred_id], references: [id])
  
  @@map("referrals")
}

model Point {
  id          Int       @id @default(autoincrement())
  user_id     Int
  amount      Int
  type        PointType
  description String    @db.Text
  created_at  DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@map("points")
}

// schema.prisma

model Setting {
  id          Int     @id @default(autoincrement())
  key         String  @unique @db.VarChar(50) // Nama pengaturan, e.g., "referral_reward_co"
  value       String?  @db.Text                 // Nilai pengaturan, e.g., "100"
  description String? @db.Text                 // Penjelasan tentang pengaturan ini

  @@map("settings")
}

model VerificationToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  type       TokenType 
  expires_at DateTime
  user_id    Int
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("verification_tokens")
}


enum PointType {
  referral
  transaction
  redeem
}

enum Role {
  admin
  mitra
  co
  customer
}

enum Status {
  pending
  approved
  rejected
  active
}

enum Gender {
  pria
  perempuan
}

enum PicStatus {
  pemilik
  pengelola
}

enum BusinessType {
  jual_beli_kendaraan
  bengkel
  cuci_kendaraan
  jual_beli_sparepart
  sewa_kendaraan
  insurance_consultant
  pembiayaan
  biro_jasa
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}