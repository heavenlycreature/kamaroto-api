// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(100)
  email      String   @unique @db.VarChar(100)
  password   String   @db.VarChar(255)
  role       Role     @default(customer)
  status     Status   @default(pending)
  rejection_reason  String?  @db.Text
  resubmitted_at  DateTime? @db.Timestamptz(6)
  resubmit_allowed  Boolean @default(true) 
  phone      String   @unique @db.VarChar(20)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  email_is_verified Boolean @default(false)
  

  coProfile    CoProfile?
  mitraProfile MitraProfile?

  referred     Referral[] @relation("ReferredUsers")
  referralsMade Referral[] @relation("ReferringUsers")
  verificationTokens VerificationToken[]
  points        Point[]
}

model CoProfile {
  id                Int      @id @default(autoincrement())
  user_id           Int      @unique
  name              String   @db.VarChar(100)
  email             String   @unique @db.VarChar(100)
  nik               String   @unique @db.VarChar(20)
  birth_place       String   @db.VarChar(100)
  birth_date        DateTime @db.Date
  gender            Gender
  address_province_code String   @db.VarChar(10)
  address_province_name String   @db.VarChar(100)
  address_regency_code  String   @db.VarChar(10)
  address_regency_name  String   @db.VarChar(100)
  address_district_code String   @db.VarChar(10)
  address_district_name String   @db.VarChar(100)
  address_village_code  String   @db.VarChar(10)
  address_village_name  String   @db.VarChar(100)
  address_postal_code   String   @db.VarChar(10)
  address_detail    String   @db.Text
  job               String   @db.VarChar(100)
  marital_status    String   @db.VarChar(50)
  education         String   @db.VarChar(50)
  selfie_url        String   @db.VarChar(255)
  is_verified       Boolean  @default(false)
  approved_at       DateTime? @db.Timestamptz(6)
  referral_code String? @unique @db.VarChar(10)
  latitude          Float?
  longitude         Float?


  user User @relation(fields: [user_id], references: [id])

  @@map("co_profiles")
}

model MitraProfile {
  id                        Int      @id @default(autoincrement())
  user_id                   Int      @unique
  pic_name                  String   @db.VarChar(100)
  pic_phone                 String   @db.VarChar(20)
  pic_email                 String   @db.VarChar(100)
  pic_status                PicStatus
  owner_name                String   @db.VarChar(100)
  owner_phone               String   @unique @db.VarChar(20)
  owner_email               String   @db.VarChar(100)
  owner_ktp                 String   @db.VarChar(50)
  owner_address_province_code String   @db.VarChar(10)
  owner_address_province_name String   @db.VarChar(100)
  owner_address_regency_code  String   @db.VarChar(10)
  owner_address_regency_name  String   @db.VarChar(100)
  owner_address_district_code String   @db.VarChar(10)
  owner_address_district_name String   @db.VarChar(100)
  owner_address_village_code  String   @db.VarChar(10)
  owner_address_village_name  String   @db.VarChar(100)
  owner_address_detail      String   @db.Text
  owner_address_postal_code   String   @db.VarChar(10)
  business_type             BusinessType
  business_entity           String   @db.VarChar(50)
  business_name             String?   @db.VarChar(100)
  business_address_province_code String   @db.VarChar(10)
  business_address_province_name String   @db.VarChar(100)
  business_address_regency_code  String   @db.VarChar(10)
  business_address_regency_name  String   @db.VarChar(100)
  business_address_district_code String   @db.VarChar(10)
  business_address_district_name String   @db.VarChar(100)
  business_address_village_code  String   @db.VarChar(10)
  business_address_village_name  String   @db.VarChar(100)
  business_address_postal_code   String   @db.VarChar(10)
  business_address_detail   String   @db.Text
  business_duration         String   @db.VarChar(50)
  social_media_platform     String   @db.VarChar(50)
  social_media_account      String   @db.VarChar(100)
  is_verified               Boolean  @default(false)
  approved_at               DateTime? @db.Timestamptz(6)
  latitude                  Float?
  longitude                 Float?
  store_images              String  @db.Text

  business_logo_url         String?  @db.Text
  business_banner_url       String?  @db.Text
  openHours                 Json?     // Contoh: { "monday": "09:00-17:00", "tuesday": "09:00-17:00" }

  user User @relation(fields: [user_id], references: [id])

  products                         Product[]
  mechanics                        Mechanic[]
  workshopSlots                    WorkshopSlot[]
  washSlots                        WashSlot[]

  @@map("mitra_profiles")
}

model Address {
  id          Int      @id @default(autoincrement())
  province    String   // e.g., "DKI Jakarta"
  city        String   // e.g., "Jakarta Pusat"
  district    String   // Kecamatan, e.g., "Gambir"
  subdistrict String   // Kelurahan, e.g., "Petojo Selatan"
  latitude    Float
  longitude   Float
  
  @@unique([province, city, district, subdistrict]) // Menjamin setiap alamat unik
}

model Referral {
  id           Int     @id @default(autoincrement())
  referrer_id  Int     // ID dari CO yang memberi referral
  referred_id  Int     @unique // ID dari user baru yang direferensikan
  type         Role    // 'co' atau 'mitra'
  reward_point Int
  rewarded     Boolean @default(false)
  created_at   DateTime @default(now())

  referrer User @relation("ReferringUsers", fields: [referrer_id], references: [id])
  referred User @relation("ReferredUsers", fields: [referred_id], references: [id])
  
  @@map("referrals")
}

model Point {
  id          Int       @id @default(autoincrement())
  user_id     Int
  amount      Int
  type        PointType
  description String    @db.Text
  created_at  DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@map("points")
}

// ===============================================
// SKEMA UNTUK FITUR MITRA & PRODUK
// ===============================================



// Model Toko (milik Mitra)
model Store {
  id          String @id @default(cuid())
  name        String
  address     String
  latitude    Float?
  longitude   Float?
  openHours   Json?     // Contoh: { "monday": "09:00-17:00", "tuesday": "09:00-17:00" }
  phone       String?
  status      StoreStatus @default(ACTIVE)

  // Relasi 1-ke-1 dengan User (Mitra)
  user        User   @relation(fields: [userId], references: [id])
  userId      String @unique

  // Relasi 1-ke-Banyak
  products    Product[]
  mechanics   Mechanic[]
  workshopSlots WorkshopSlot[]
  washSlots   WashSlot[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Model Produk atau Layanan yang dijual Mitra
model Product {
  id          String        @id @default(cuid())
  type        ProductType
  title       String
  description String?       @db.Text
  price       Decimal       @db.Decimal(12, 2)
  stock       Int           @default(1)
  status      ProductStatus @default(DRAFT)
  attributes  Json?         // Fleksibel untuk detail spesifik per tipe produk

  // Relasi ke Toko
  mitraProfile    MitraProfile @relation(fields: [mitraProfileId], references: [id])
  mitraProfileId  Int

  // Relasi 1-ke-Banyak (opsional)
  media       ProductMedia[]

  // Relasi 1-ke-1 ke tabel ekstensi (jika tipe produknya sesuai)
  vehicleDetail  VehicleDetail?
  rentalVehicle  RentalVehicle?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([storeId])
}

// Model Media untuk Produk (foto, video, dll.)
model ProductMedia {
  id        String   @id @default(cuid())
  url       String
  type      String   // "IMAGE" atau "VIDEO"
  order     Int      @default(0) // Untuk urutan tampilan

  product   Product @relation(fields: [productId], references: [id])
  productId String

  createdAt DateTime @default(now())
}

// --- Tabel Ekstensi untuk Produk ---

// Detail untuk produk tipe VEHICLE (jual beli)
model VehicleDetail {
  id              String   @id @default(cuid())
  brand           String
  model           String
  year            Int
  odometer        Int
  condition       String?  // Contoh: "Sangat Baik", "Baik", "Cukup"

  // Relasi 1-ke-1
  product   Product @relation(fields: [productId], references: [id])
  productId String  @unique
}

// Detail untuk produk tipe RENTAL
model RentalVehicle {
  id              String   @id @default(cuid())
  plateNumber     String   @unique
  brand           String
  model           String
  year            Int
  mileage         Int
  fuelPolicy      String   // Contoh: "Full to Full", "Same to Same"
  dailyPrice      Decimal  @db.Decimal(10, 2)
  depositRequired Boolean  @default(false)
  depositAmount   Decimal? @db.Decimal(10, 2)

  // Relasi 1-ke-1
  product   Product @relation(fields: [productId], references: [id])
  productId String  @unique

  // Relasi untuk blackout dates
  blackoutDates RentalBlackout[]
}

// Tabel untuk menyimpan tanggal-tanggal di mana kendaraan rental tidak tersedia
model RentalBlackout {
  id              String   @id @default(cuid())
  startDate       DateTime @db.Date
  endDate         DateTime @db.Date
  reason          String?

  rentalVehicle   RentalVehicle @relation(fields: [rentalVehicleId], references: [id])
  rentalVehicleId String

  createdAt DateTime @default(now())
}

// ===============================================
// SKEMA UNTUK MANAJEMEN BENGKEL & CUCI
// ===============================================

enum MechanicStatus {
  AVAILABLE
  ON_LEAVE
  INACTIVE
}

// Model Mekanik yang bekerja di sebuah Toko/Bengkel
model Mechanic {
  id        String         @id @default(cuid())
  name      String
  skillset  String?        // Contoh: "Spesialis Mesin Toyota, Umum"
  status    MechanicStatus @default(AVAILABLE)

  mitraProfile    MitraProfile @relation(fields: [mitraProfileId], references: [id])
  mitraProfileId  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Model Slot untuk Bengkel (Workshop)
model WorkshopSlot {
  id                 String   @id @default(cuid())
  date               DateTime @db.Date
  hour               Int      // Jam mulai, format 24h (e.g., 9 untuk 09:00)
  capacity           Int      // Jumlah mobil yang bisa ditangani di jam ini
  mechanicsAvailable Int      // Jumlah mekanik yang tersedia di jam ini

  mitraProfile       MitraProfile @relation(fields: [mitraProfileId], references: [id])
  mitraProfileId     Int


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mitraProfileId, date, hour]) // Slot unik per mitra per jam per hari
}

// Model Slot untuk Cuci Kendaraan
model WashSlot {
  id         String   @id @default(cuid())
  date       DateTime @db.Date
  hour       Int
  capacity   Int

  mitraProfile       MitraProfile @relation(fields: [mitraProfileId], references: [id])
  mitraProfileId     Int


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mitraProfileId, date, hour])
}

model Setting {
  id          Int     @id @default(autoincrement())
  key         String  @unique @db.VarChar(50) // Nama pengaturan, e.g., "referral_reward_co"
  value       String?  @db.Text                 // Nilai pengaturan, e.g., "100"
  description String? @db.Text                 // Penjelasan tentang pengaturan ini

  @@map("settings")
}

model VerificationToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  type       TokenType 
  expires_at DateTime
  user_id    Int
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("verification_tokens")
}


enum PointType {
  referral
  transaction
  redeem
}

enum Role {
  admin
  mitra
  co
  customer
}

enum Status {
  pending
  approved
  rejected
  active
}

enum Gender {
  pria
  perempuan
}

enum PicStatus {
  pemilik
  pengelola
}

enum BusinessType {
  jual_beli_kendaraan
  bengkel
  cuci_kendaraan
  jual_beli_sparepart
  sewa_kendaraan
  insurance_consultant
  pembiayaan
  biro_jasa
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

// Enum untuk tipe-tipe yang digunakan berulang kali
enum ProductType {
  VEHICLE
  SPAREPART
  SERVICE
  WASH
  RENTAL
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

enum StoreStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}